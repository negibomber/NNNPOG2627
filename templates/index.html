<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>POGãƒ‰ãƒ©ãƒ•ãƒˆ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: sans-serif; margin: 0; background-color: #f4f7f6; display: flex; flex-direction: row; height: 100vh; overflow: hidden; }
        
        .mc-sidebar { width: 220px; background: #2c3e50; color: white; padding: 20px; display: none; flex-direction: column; flex-shrink: 0; overflow-y: auto; z-index: 2000; }
        .mc-btn { width: 100%; padding: 12px; margin: 8px 0; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; background: #34495e; color: white; }
        .mc-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        
        .mc-btn-active { background: #e74c3c !important; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        
        .main-content { flex: 1; overflow-y: auto; padding: 20px; position: relative; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 20px; border-radius: 12px; }
        
        #ui-reveal { 
            display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
            background: radial-gradient(circle, #2c3e50 0%, #000000 100%); 
            color: white; z-index: 3000; flex-direction: column; justify-content: center; align-items: center; text-align: center;
            cursor: pointer;
        }
        #rev-player { font-size: 2.2em; color: #28a745; margin-bottom: 20px; text-shadow: 2px 2px 10px rgba(0,0,0,0.8); }
        #rev-horse { font-size: 7em; font-weight: 900; margin: 30px 0; letter-spacing: 8px; text-shadow: 0 0 30px rgba(40,167,69,0.9); }
        #rev-info { font-size: 2em; border-top: 2px solid rgba(255,255,255,0.2); padding-top: 25px; color: #ccc; }

        .draft-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 10px; margin-top: 15px; }
        .result-card { background: #fafafa; border: 1px solid #ddd; padding: 10px; border-radius: 8px; text-align: center; }
        .status-win { border: 3px solid #28a745; background-color: #e8f5e9; font-weight: bold; }
        .status-duplicate { border: 3px solid #e67e22; background: #fff4e5; }
        .status-lose { border: 3px solid #dc3545; background: #ffebee; }

        .table-container { width: 100%; overflow-x: auto; margin-top: 30px; border: 1px solid #ddd; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; min-width: 1200px; font-size: 0.85em; table-layout: fixed; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: center; vertical-align: top; }
        th { background-color: #f8f9fa; position: sticky; top: 0; }
        .horse-name { display: block; font-weight: bold; color: #28a745; }
        .parent-info { display: block; font-size: 0.8em; color: #666; }
        .cell-win { background-color: #e8f5e9; }

        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #28a745; margin-bottom: 20px; }
        .user-panel { display: flex; justify-content: flex-end; align-items: center; gap: 15px; margin-bottom: 10px; }
        .logout-btn { color: #dc3545; text-decoration: none; padding: 2px 8px; border: 1px solid #dc3545; border-radius: 4px; }
        
        #nomination-count { background: #f8f9fa; border: 1px solid #28a745; color: #28a745; padding: 5px 12px; border-radius: 15px; font-weight: bold; font-size: 0.9em; }
    </style>
</head>
<body id="pog-body" data-user="{{ user }}" data-mc="{{ is_mc }}">

<div class="mc-sidebar" id="mc-sidebar">
    <h3>å¸ä¼šé€²è¡Œ</h3>
    <button id="btn-start-reveal" class="mc-btn" onclick="mcAction('/mc/start_reveal', true)">â‘  ç™ºè¡¨é–‹å§‹ (è‡ªå‹•é€ã‚Š)</button>
    <button id="btn-run-lottery" class="mc-btn" style="background:#e67e22;" onclick="mcAction('/mc/run_lottery')">â‘¡ æŠ½é¸å®Ÿè¡Œ</button>
    <button id="btn-next-round" class="mc-btn" style="background:#2196f3;" onclick="mcAction('/mc/next_round')">â‘¢ æ¬¡ã®æŒ‡åã¸</button>
    
    <div style="font-size:0.75em; margin-top:20px; color:#bdc3c7; line-height:1.4;">
        <p><strong>ã€é€²è¡Œãƒ’ãƒ³ãƒˆã€‘</strong><br>
        é‡è¤‡ãŒãªã„å ´åˆã¯è‡ªå‹•ã§ç¢ºå®šã—ã¾ã™ã€‚<br>
        é‡è¤‡ãŒã‚ã‚‹å ´åˆã¯ã€ŒæŠ½é¸å®Ÿè¡Œã€ãŒå¿…è¦ã§ã™ã€‚</p>
    </div>
</div>

<div class="main-content">
    <div class="container">
        <div class="user-panel">
            <span>ãƒ­ã‚°ã‚¤ãƒ³ï¼š<strong>{{ user }}</strong></span>
            <a href="/logout" class="logout-btn">é€€å‡º</a>
        </div>
        
        <div class="header">
            <div style="display:flex; align-items:center; gap:15px;">
                <h1>POGãƒ‰ãƒ©ãƒ•ãƒˆ</h1>
                <div id="nomination-count">0/0äººæŒ‡å</div>
            </div>
            <div id="round-badge" style="background:#28a745; color:white; padding:5px 15px; border-radius:20px;">ç¬¬ {{ current_round }} å·¡ç›®</div>
        </div>

        <div id="personal-status"></div>

        <div id="ui-nomination">
            <div id="nomination-form-container">
                <p><strong>é¦¬ã‚’æ¤œç´¢ã—ã¦æŒ‡åã—ã¦ãã ã•ã„ï¼š</strong></p>
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <input type="text" id="f-in" style="flex:1; padding:12px; border:1px solid #ddd; border-radius:6px;" placeholder="çˆ¶åæ¤œç´¢">
                    <input type="text" id="m-in" style="flex:1; padding:12px; border:1px solid #ddd; border-radius:6px;" placeholder="æ¯åæ¤œç´¢">
                </div>
                <div id="results" style="max-height: 200px; overflow-y: auto;"></div>
                <div style="margin:15px 0;">é¸æŠä¸­ï¼š <strong id="sel-txt" style="color:#2196f3;">ãªã—</strong></div>
                <button id="nominate-btn" disabled style="width:100%; padding:15px; background:#2196f3; color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer;">æŒ‡åã‚’ç¢ºå®šãƒ»ä¿®æ­£ã™ã‚‹</button>
            </div>
            <div id="nomination-waiting-msg" style="display:none; text-align:center; padding:20px; background:#eee; border-radius:10px;">
                ä»–ã®å‚åŠ è€…ã®å…¥åŠ›ã‚’å¾…ã£ã¦ã„ã¾ã™...
            </div>
        </div>

        <div id="ui-lottery" style="display:none; margin-top:20px;">
            <h4 style="text-align:center; border-bottom:1px solid #eee; padding-bottom:10px;">æŒ‡åé‡è¤‡çŠ¶æ³</h4>
            <div class="draft-grid" id="result-grid"></div>
        </div>

        <div class="table-container">
            <h4 style="text-align:center; margin:10px 0;">ç²å¾—é¦¬ä¸€è¦§</h4>
            <table id="draft-table">
                <thead><tr id="table-head"><th>å·¡ç›®</th></tr></thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="ui-reveal" onclick="handleRevealNext(event)">
    <div id="rev-player"></div>
    <div id="rev-horse"></div>
    <div id="rev-info"></div>
</div>

<script>
    (function() {
        const body = document.getElementById('pog-body');
        const loginUser = body.getAttribute('data-user');
        const isMc = body.getAttribute('data-mc') === '1';
        let autoTimer = null;
        let players = []; 
        let currentPhase = "";
        let currentRoundNumber = parseInt("{{ current_round }}");

        if (isMc) {
            document.getElementById('mc-sidebar').style.display = 'flex';
            window.addEventListener('keydown', (e) => {
                if (currentPhase === 'reveal' && (e.code === 'Space' || e.code === 'Enter')) {
                    e.preventDefault();
                    triggerNextReveal();
                }
            });
        }

        window.handleRevealNext = function(e) {
            if (isMc && currentPhase === 'reveal') {
                triggerNextReveal();
            }
        };

        function triggerNextReveal() {
            if (autoTimer) { 
                clearInterval(autoTimer); 
                autoTimer = null; 
                document.getElementById('btn-start-reveal').classList.remove('mc-btn-active'); 
            }
            mcAction('/mc/next_reveal');
        }

        function clearSearchForm() {
            document.getElementById('f-in').value = "";
            document.getElementById('m-in').value = "";
            document.getElementById('results').innerHTML = "";
            document.getElementById('sel-txt').innerText = "ãªã—";
            document.getElementById('nominate-btn').disabled = true;
        }

        function updateView(st) {
            if (currentRoundNumber !== st.round) {
                currentRoundNumber = st.round;
                clearSearchForm();
            }
            
            currentPhase = st.phase;
            const uiNom = document.getElementById('ui-nomination');
            const uiRev = document.getElementById('ui-reveal');
            const uiLot = document.getElementById('ui-lottery');
            const formCont = document.getElementById('nomination-form-container');
            const waitMsg = document.getElementById('nomination-waiting-msg');
            const statusBox = document.getElementById('personal-status');

            if (st.all_players && JSON.stringify(st.all_players) !== JSON.stringify(players)) {
                players = st.all_players;
                const head = document.getElementById('table-head');
                while (head.cells.length > 1) head.deleteCell(1);
                players.forEach(p => {
                    const th = document.createElement('th');
                    th.innerText = p;
                    head.appendChild(th);
                });
            }

            const currentRoundNoms = st.all_nominations.filter(n => n.round === st.round);
            const nominatedCount = currentRoundNoms.filter(n => n.is_winner === 0).length;
            const winnersInThisRound = currentRoundNoms.filter(n => n.is_winner === 1).length;
            const totalDone = nominatedCount + winnersInThisRound;
            document.getElementById('nomination-count').innerText = `${totalDone}/${players.length}äººæŒ‡å`;

            const myWin = st.all_nominations.find(n => n.player_name === loginUser && n.round === st.round && n.is_winner === 1);
            const myNom = st.all_nominations.find(n => n.player_name === loginUser && n.round === st.round && n.is_winner === 0);

            if (myWin) {
                statusBox.innerHTML = `<div style="background:#e8f5e9; padding:15px; border-left:5px solid #28a745; margin-bottom:20px; font-weight:bold; color:#28a745;">ğŸ† å½“é¸ç¢ºå®šï¼š${myWin.horse_name}</div>`;
                uiNom.style.display = 'block';
                formCont.style.display = 'none';
                waitMsg.style.display = 'block';
                waitMsg.innerText = "å½“é¸ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼æ¬¡ã®å·¡ç›®ã¾ã§å¾…æ©Ÿã—ã¦ãã ã•ã„ã€‚";
            } else {
                statusBox.innerHTML = myNom ? `<div style="background:#e3f2fd; padding:15px; border-left:5px solid #2196f3; margin-bottom:20px;">ğŸ“ æŒ‡åå®Œäº†ï¼š${myNom.horse_name}</div>` : "";
                uiNom.style.display = (st.phase === 'nomination') ? 'block' : 'none';
                formCont.style.display = (st.phase === 'nomination') ? 'block' : 'none';
                waitMsg.style.display = 'none';
            }

            if (st.phase === 'reveal' && st.reveal_data) {
                uiRev.style.display = 'flex';
                document.getElementById('rev-player').innerText = st.reveal_data.player + " ã•ã‚“ã®æŒ‡åã¯...";
                document.getElementById('rev-horse').innerText = st.reveal_data.horse;
                document.getElementById('rev-info').innerHTML = `çˆ¶: ${st.reveal_data.father} Ã— æ¯: ${st.reveal_data.mother}`;
            } else {
                uiRev.style.display = 'none';
                if (autoTimer) { clearInterval(autoTimer); autoTimer = null; document.getElementById('btn-start-reveal').classList.remove('mc-btn-active'); }
            }

            // é‡è¤‡ãƒã‚§ãƒƒã‚¯
            const horseCounts = {};
            currentRoundNoms.forEach(n => horseCounts[n.horse_name] = (horseCounts[n.horse_name] || 0) + 1);
            const hasDuplicate = Object.values(horseCounts).some(count => count > 1);
            const hasLotteryResult = currentRoundNoms.some(n => n.is_winner === 1 || n.is_winner === -1);

            if (st.phase === 'lottery') {
                uiLot.style.display = 'block';
                const grid = document.getElementById('result-grid');
                grid.innerHTML = currentRoundNoms.map(n => {
                    let cls = ""; let tag = "";
                    if (n.is_winner === 1) { cls = "status-win"; tag = "å½“é¸"; }
                    else if (n.is_winner === -1) { cls = "status-lose"; tag = "è½é¸"; }
                    else if (horseCounts[n.horse_name] > 1) { cls = "status-duplicate"; tag = "é‡è¤‡"; }
                    else { tag = "å˜ç‹¬"; }
                    return `<div class="result-card ${cls}"><div>${n.player_name}</div><strong>${n.horse_name}</strong><br><small>${tag}</small></div>`;
                }).join('');
            } else {
                uiLot.style.display = 'none';
            }

            const tableBody = document.getElementById('table-body');
            let tableHtml = "";
            for (let r = 1; r <= 10; r++) {
                let row = `<tr><td><strong>${r}</strong></td>`;
                players.forEach(p => {
                    const win = st.all_nominations.find(n => n.player_name === p && n.round === r && n.is_winner === 1);
                    if (win) {
                        row += `<td class="cell-win"><span class="horse-name">${win.horse_name}</span><span class="parent-info">çˆ¶:${win.father_name}<br>æ¯:${win.mother_name}</span></td>`;
                    } else {
                        row += `<td>-</td>`;
                    }
                });
                tableHtml += row + "</tr>";
            }
            tableBody.innerHTML = tableHtml;

            if (isMc) {
                const isAllDone = (totalDone === players.length && players.length > 0);
                document.getElementById('btn-start-reveal').disabled = (st.phase !== 'nomination' || !isAllDone);
                
                // é‡è¤‡ãŒã‚ã‚‹å ´åˆã®ã¿ã€ŒæŠ½é¸å®Ÿè¡Œã€ã‚’æœ‰åŠ¹ã«ã™ã‚‹
                document.getElementById('btn-run-lottery').disabled = (st.phase !== 'reveal' && st.phase !== 'lottery') || !hasDuplicate;
                
                // æ¬¡ã®å·¡ç›®ã¸ï¼š
                // 1. é‡è¤‡ãŒãªã„å ´åˆã¯ã€ç™ºè¡¨ãŒçµ‚ã‚ã£ãŸ(lotteryãƒ•ã‚§ãƒ¼ã‚ºã«å…¥ã£ãŸ)æ™‚ç‚¹ã§æŠ¼ã›ã‚‹
                // 2. é‡è¤‡ãŒã‚ã‚‹å ´åˆã¯ã€æŠ½é¸çµæœãŒå‡ºã‚‹ã¾ã§æŠ¼ã›ãªã„
                const canGoNext = (st.phase === 'lottery' && (!hasDuplicate || hasLotteryResult));
                document.getElementById('btn-next-round').disabled = !canGoNext;
            }
            document.getElementById('round-badge').innerText = `ç¬¬ ${st.round} å·¡ç›®`;
        }

        let selectedHorse = ""; let selectedMother = "";
        const fIn = document.getElementById('f-in'); const mIn = document.getElementById('m-in'); const btnNom = document.getElementById('nominate-btn');
        const search = async () => {
            if (!fIn.value.trim() && !mIn.value.trim()) {
                document.getElementById('results').innerHTML = "";
                return;
            }
            const r = await fetch(`/search_horses?f=${encodeURIComponent(fIn.value)}&m=${encodeURIComponent(mIn.value)}`);
            const data = await r.json();
            document.getElementById('results').innerHTML = data.map(h => `
                <div style="padding:10px; border-bottom:1px solid #eee; cursor:pointer;" onclick="selectH(this,'${h.horse_name}','${h.mother_name}')">
                    <strong>${h.horse_name}</strong><br><small>çˆ¶:${h.father_name} æ¯:${h.mother_name}</small>
                </div>
            `).join('');
        };
        if(fIn){ fIn.oninput = search; mIn.oninput = search; }
        window.selectH = (el, h, m) => { 
            selectedHorse = h; selectedMother = m; document.getElementById('sel-txt').innerText = h; btnNom.disabled = false; 
            document.querySelectorAll('#results div').forEach(i => i.style.background = 'white'); el.style.background = '#e3f2fd';
        };
        if(btnNom) btnNom.onclick = async () => { 
            const fd = new URLSearchParams(); fd.append('horse_name', selectedHorse); fd.append('mother_name', selectedMother); 
            await fetch('/nominate', { method: 'POST', body: fd }); 
            clearSearchForm();
            document.getElementById('sel-txt').innerText = "é€ä¿¡å®Œäº†"; 
        };
        
        window.mcAction = (url, startAuto = false) => { 
            fetch(url, {method:'POST'}); 
            if (startAuto && !autoTimer) {
                autoTimer = setInterval(() => fetch('/mc/next_reveal', {method:'POST'}), 5000); 
                document.getElementById('btn-start-reveal').classList.add('mc-btn-active');
            }
        };

        setInterval(async () => {
            try {
                const res = await fetch('/status'); const st = await res.json(); updateView(st);
            } catch(e) {}
        }, 2000);
    })();
</script>
</body>
</html>